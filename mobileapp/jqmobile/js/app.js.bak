$.mobile.changePage.defaults.allowSamePageTransition = true;
storage=$.localStorage;
api = 'http://localhost:5000/api/'

/*
$(document).bind("pageinit", function() {
    //init();
    $('#btn_login').click(function() {login();});
})
*/

function change_page(url, param){
    url_p = 
    $.mobile.changePage('page2.html', 
        { dataUrl : "page2.html?paremeter=123", data : { 'paremeter' : '123' }, 
        reloadPage : true, 
        changeHash : true 
    });
}

function _api(url, cb){
    $.ajax
    ({
        type: "GET",
        url: api + url + '?api_key='+_g('api_key'),
        dataType: 'json',
        crossDomain: true,
        success: cb
    });
}

function show_page(p){
    $('[data-role="page"]').hide();
    $('#page-'+p).show();
    _s('page', p);
}

/* View logic */
function load_page(p){
    if (p=='lists'){
        cb = (function(data) {
            lt = $('#tpl-list').html();
            $.each(data, function(){
                $('#ul-lists').append(lt.format(this.ListID, this.ListName));
            })
            $('#ul-lists').listview('refresh');
        });
        _api('lists', cb);
    }
    else if (p=='messages'){
        cb = (function(data) {
            _s('messages', data);
            mt = $('#tpl-message').html();
            $.each(data, function(){
                $('#ul-messages').append(mt.format(this.MsgID, this.Subject));
            })
            $('#ul-messages').listview('refresh');
        });
        _api('messages/'+_g('list_id'), cb);
    }
    else if (p=='message'){
        msgs = _g('messages');
        $.each(msgs, function() {
            if (this.MsgId = _g('msg_id')){
                for (var key in this){
                    $('#m_'+key).html(this[key]);
                }
            }
        });
    }
}

function change_page2(p){
    $.mobile.changePage( "#page-"+p, {transition: 'slide'} );
    _s('page', p);
    load_page(p);
}


function _g(k){
    return storage.get(k);
}

function _s(k, v){
    storage.set(k, v);
}

function login(){
    u = $('#username').val();
    p = $('#password').val();
    $.ajax({
      type: "POST",
      url: api + 'verify',
      crossDomain: true,
      data: {username:u, password:p},
      dataType: 'json',
      success: function (data){
        if (data.status == 'OK'){
            _s('api_key', data.message);
            _s('logged_in', true);
            //$("#a_lists").click();
            alert('a');
            $.mobile.changePage('lists.html', {reloadPage : false, changeHash : false });
        }
        else {
            $('#login_error').html(data).show();
        }
      }
    });         
}

function select_list(l){
    _s('list_id',l);
    document.location='#page-messages';  
}

function select_message(m){
    _s('msg_id',m);
    document.location='#page-message';  
}

function init(){
    //_s('logged_in',null);
    if (_g('logged_in')){
        if (_g('page')) {
            window.location = _g('page') + '.html'
            //change_page(_g('page'));
        }
        else {
            //change_page('lists');
            window.location = 'lists.html';
        }
        //change_page('login');
        //('#page-login').show();
    }
    else {
        window.location = 'login.html';
    }
}

/* Get query value helper */
function _q(name) {
    name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
    return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
}

String.prototype.format = function() {
  var args = arguments;
  return this.replace(/{(\d+)}/g, function(match, number) { 
    return typeof args[number] != 'undefined'
      ? args[number]
      : match
    ;
  });
};